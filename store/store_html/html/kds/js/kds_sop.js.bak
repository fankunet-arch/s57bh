/* TopTea · KDS — SOP 查询与渲染（两列大卡；仅用现有容器）
 * 修复：1) Tab 可切换  2) 名称兜底显示  3) 左侧参数平板友好字号
 * 绑定：#sku-search-form（提交/回车/按钮）
 * 容器：#cards-base / #cards-mixing / #cards-topping / #cards-waiting
 * 版本：2025-10-31 R7
 */
(function () {
  if (window.__KDS_SOP_BOUND__) return;
  window.__KDS_SOP_BOUND__ = true;

  /* ------------ 工具 ------------ */
  function apiUrl() {
    var p = location.pathname; // 例：/kds/index.php
    var base = p.replace(/\/index\.php.*$/i, '');
    if (!base || base === p) base = p.replace(/\/[^\/]+$/, '');
    if (!base.endsWith('/')) base += '/';
    return base + 'api/sop_handler.php';
  }
  function normalize(raw) {
    if (!raw) return '';
    raw = ('' + raw).trim().toUpperCase();
    if (!/^[A-Z0-9-]+$/.test(raw)) return '';
    var seg = raw.split('-').filter(Boolean);
    if (seg.length > 4) return '';
    return seg.join('-');
  }
  function normPayload(d) {
    if (!d) return {base:[],mix:[],top:[]};
    if (d.adjusted_recipe) return Object.assign({base:[],mix:[],top:[]}, d.adjusted_recipe);
    if (d.steps)          return Object.assign({base:[],mix:[],top:[]}, d.steps);
    if (d.base || d.mix || d.top) return Object.assign({base:[],mix:[],top:[]}, d);
    if (d.steps_json_zh) { try { return Object.assign({base:[],mix:[],top:[]}, JSON.parse(d.steps_json_zh)); } catch(e){} }
    return {base:[],mix:[d],top:[]};
  }

  /* ------------ 仅使用既有容器 ------------ */
  var elBase = document.getElementById('cards-base');
  var elMix  = document.getElementById('cards-mixing');
  var elTop  = document.getElementById('cards-topping');
  var elWait = document.getElementById('cards-waiting');
  var infoBox= document.getElementById('kds-info-display-container');

  function clearAll(){ if (elBase) elBase.innerHTML=''; if (elMix) elMix.innerHTML=''; if (elTop) elTop.innerHTML=''; }
  function setWaiting(msg){
    clearAll();
    if (elWait){
      elWait.style.display=''; // 显隐交由页面样式控制
      var h4 = elWait.querySelector('h4');
      if (h4) h4.textContent = msg || '等待查询...';
    }
  }
  function hideWaiting(){ if (elWait) elWait.style.display='none'; }

  /* ------------ 两列大卡片（与示例风格一致） ------------ */
  function tileCol(i, name, qty, unit){
    var col = document.createElement('div');
    col.className = 'col-12 col-lg-6';

    var html =
      '<div class="card shadow-sm border-0 h-100 position-relative">' +
        '<span class="position-absolute top-0 start-0 translate-middle badge rounded-pill bg-success" style="z-index:1;">' + (i+1) + '</span>' +
        '<div class="card-body d-flex align-items-center gap-3" style="min-height:120px;">' +
          '<div class="rounded bg-body-secondary d-flex align-items-center justify-content-center" style="width:56px;height:56px;">' +
            '<i class="bi bi-image" style="opacity:.35;font-size:1.5rem;"></i>' +
          '</div>' +
          '<div class="flex-grow-1">' +
            '<div class="fw-bold mb-1 kds-item-title" style="font-size:1.05rem;line-height:1.2;">' + name + '</div>' +
            '<div class="d-flex align-items-baseline gap-2">' +
              '<div class="text-danger fw-bold" style="font-size:2rem;line-height:1;">' + (qty!=null?qty:'') + '</div>' +
              '<div class="text-muted" style="font-size:.9rem;">' + (unit||'') + '</div>' +
            '</div>' +
          '</div>' +
        '</div>' +
      '</div>';

    col.innerHTML = html;
    return col;
  }

  function renderTiles(el, items){
    if (!el) return;
    el.innerHTML='';
    var wrap = document.createElement('div');
    wrap.className = 'row g-3';

    if (!items || !items.length){
      var empty = document.createElement('div');
      empty.className='col-12';
      empty.innerHTML='<div class="text-muted small py-3">（本步骤无用料）</div>';
      wrap.appendChild(empty);
    } else {
      items.forEach(function (it, idx) {
        var name = (it && (it.material_name || it.name || it.label)) || ('#' + (it && it.material_id ? it.material_id : ''));
        if (!name) name = '未命名'; // 名称兜底，避免空白
        var qty  = (it && (it.qty!=null ? it.qty : it.quantity));
        var unit = (it && it.unit) || '';
        wrap.appendChild(tileCol(idx, name, qty, unit));
      });
    }
    el.appendChild(wrap);
  }

  /* ------------ 渲染 + 左侧参数（平板友好） ------------ */
  function render(data){
    hideWaiting();
    var s = normPayload(data);
    renderTiles(elBase, s.base);
    renderTiles(elMix,  s.mix);
    renderTiles(elTop,  s.top);

    if (infoBox){
      var lines = [];
      var meta = (data && data.meta) || {};
      if (meta.product_code) lines.push('编码：' + meta.product_code);
      if (meta.cup_code    ) lines.push('杯型：' + meta.cup_code);
      if (meta.ice_code    ) lines.push('冰度：' + meta.ice_code);
      if (meta.sweet_code  ) lines.push('糖度：' + meta.sweet_code);

      infoBox.innerHTML =
        '<div class="d-flex flex-column gap-2" style="font-size:1rem;line-height:1.4;">' +
          lines.map(function(t){ return '<div class="text-body-secondary">'+t+'</div>'; }).join('') +
        '</div>';
    }
  }

  function query(codeRaw){
    var code = normalize(codeRaw);
    if (!code){ setWaiting('请输入合法编码（示例：101 或 101-1-1-11）'); return; }
    setWaiting('正在查询：' + code + ' …');
    fetch(apiUrl() + '?code=' + encodeURIComponent(code), { cache:'no-store' })
      .then(function(r){ return r.json(); })
      .then(function(j){
        if (j && j.status==='success' && j.data) render(j.data);
        else setWaiting((j && j.message) || '查询失败');
      })
      .catch(function(){ setWaiting('网络/服务器错误'); });
  }

  /* ------------ 绑定（仅挂到现有表单） ------------ */
  function bind(){
    var form = document.getElementById('sku-search-form');
    if (form){
      form.addEventListener('submit', function(e){
        e.preventDefault();
        var input = form.querySelector('input[type="text"], input[type="search"], input');
        query(input ? input.value : '');
      });
      // 支持 URL 直达 ?code=
      var params = new URLSearchParams(location.search);
      var code = params.get('code') || (location.hash.match(/code=([A-Z0-9-]+)/i) || [])[1];
      if (code) query(code);
    } else {
      // 兜底：不新增 DOM
      var input = document.getElementById('kds_code') ||
                  document.querySelector('input[type="search"], input[type="text"], input[type="tel"]');
      var btn   = input ? (input.closest('.input-group, form, .row, .col, .kds-toolbar, .toolbar, .controls') || document).querySelector('button, .btn') : null;
      if (input) input.addEventListener('keydown', function(e){ if (e.key==='Enter'){ e.preventDefault(); query(input.value); }});
      if (btn)   btn.addEventListener('click', function(){ query(input ? input.value : ''); });
    }

    /* —— Tab 切换修复：不入侵的委托 —— 
     * 当点击包含“底料/调杯/顶料”文本的按钮/链接时，强制只显示对应容器。
     * 若你原本的切换逻辑正常，这段不会造成影响；若原本失效，则提供兜底。
     */
    document.addEventListener('click', function(ev){
      var t = ev.target.closest('button, a');
      if (!t) return;
      var txt = (t.textContent || '').trim();
      var map = null;
      if (txt.indexOf('底料') !== -1) map = 'base';
      else if (txt.indexOf('调杯') !== -1) map = 'mix';
      else if (txt.indexOf('顶料') !== -1) map = 'top';
      if (!map) return;

      // 显示对应区块（不动你的类名，仅用内联 display 兜底）
      if (elBase) elBase.style.display = (map==='base') ? '' : 'none';
      if (elMix)  elMix.style.display  = (map==='mix')  ? '' : 'none';
      if (elTop)  elTop.style.display  = (map==='top')  ? '' : 'none';
    }, {passive:true});
  }

  if (document.readyState==='loading') document.addEventListener('DOMContentLoaded', bind);
  else bind();
})();
